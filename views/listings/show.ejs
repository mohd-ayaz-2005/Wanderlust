<% layout("/layouts/boilerplate") %>

<div class="row mt-3 justify-content-center">
  <div class="col-lg-8">
    <div class="d-flex flex-column flex-md-row align-items-md-center gap-2 mb-2">
      <h3 class="fw-bold mb-0"><%= listing.title %></h3>
      <% if (typeof reviewCount !== "undefined") { 
           const rounded = Math.round(avgRating || 0);
           const stars = "★".repeat(rounded) + "☆".repeat(5 - rounded);
      %>
      <div class="text-warning fw-semibold small">
        <% if (reviewCount > 0) { %>
          <span><%= stars %></span>
          <span class="text-muted">(<%= reviewCount %>)</span>
        <% } else { %>
          <span class="text-muted">No reviews yet</span>
        <% } %>
      </div>
      <% } %>
    </div>
    <% const isOwner = currentUser && listing.owner && (String(listing.owner._id || listing.owner) === String(currentUser._id)); %>

    <% const gallery = (listing.images && listing.images.length) ? listing.images : (listing.image ? [listing.image] : []); %>
    <div class="card show-card listing-card">
      <% if (gallery.length) { %>
      <div id="listingCarousel-<%= listing._id %>" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-inner">
          <% gallery.slice(0,5).forEach((img, idx) => { %>
          <div class="carousel-item <%= idx === 0 ? 'active' : '' %>">
            <img
              src="<%= img.url %>"
              class="d-block w-100 show-img"
              alt="listing-image-<%= idx %>"
            />
          </div>
          <% }) %>
        </div>
        <% if (gallery.length > 1) { %>
        <button class="carousel-control-prev" type="button" data-bs-target="#listingCarousel-<%= listing._id %>" data-bs-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#listingCarousel-<%= listing._id %>" data-bs-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Next</span>
        </button>
        <% } %>
      </div>
      <% } %>

      <div class="card-body px-4 py-3">
        <p class="card-text mb-2 text-muted">
          <i class="fa-solid fa-location-dot me-1"></i>
          <%= listing.location %>, <%= listing.country %>
        </p>
        <p class="listing-price fs-5 mb-3">
          &#8377; <%= listing.price.toLocaleString('en-IN') %>
          <span class="text-muted fs-6 fw-normal">/ night</span>
        </p>
        <p class="mb-0"><%= listing.description %></p>
      </div>
    </div>

    <% if (isOwner) { %>
      <div class="btns mt-3">
        <a href="/listings/<%= listing._id %>/edit" class="btn btn-dark edit-btn">Edit</a>

        <form method="post" action="/listings/<%= listing._id %>?_method=DELETE">
          <button class="btn btn-outline-dark ms-1">Delete</button>
        </form>
      </div>
    <% } %>

    <div class="mt-4">
      <hr>
      <h4>Leave a Review</h4>

      <form action="/listings/<%= listing.id %>/reviews" method="post" class="mb-3 mt-3">
        <label class="form-label d-block">Rating</label>
        <div class="star-rating mb-3">
          <% for (let r = 5; r >= 1; r--) { %>
          <input type="radio" id="star-<%= r %>" name="review[rating]" value="<%= r %>" required />
          <label for="star-<%= r %>" title="<%= r %> stars">★</label>
          <% } %>
        </div>

        <div class="mb-3">
          <label for="comment" class="form-label">Comment</label>
          <textarea name="review[comment]" id="comment" cols="30" rows="5" class="form-control" required></textarea>
          <div class="invalid-feedback">
            Please submit some comments for review
          </div>
        </div>

        <button class="btn btn-outline-dark">Submit</button>
      </form>

      <hr>

      <h4>All Reviews</h4>
      <div class="row">
      <% for(review of listing.reviews) {%>
      <div class="card col-md-5 ms-3 mb-3 mt-3">
        <div class="card-body">
          <h5 class="card-title">
            <%= review.author
              ? (review.author.name || review.author.username || "Guest")
              : "Guest" %>
          </h5>
          <p class="card-text mb-1"><%= review.comment %></p>
          <p class="card-text text-warning mb-0">
            <%= "★".repeat(review.rating) %><%= "☆".repeat(5 - review.rating) %>
          </p>
        </div>
        <% const isReviewOwner = currentUser && review.author && (String(review.author._id || review.author) === String(currentUser._id)); %>
        <% if (isReviewOwner) { %>
        <div class="d-flex gap-2 mb-3">
          <a class="btn btn-sm btn-outline-dark" href="/listings/<%= listing._id %>/reviews/<%= review._id %>/edit">Edit</a>
          <form  method="post" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"><button class="btn btn-sm btn-dark">Delete</button></form>
        </div>
        <% } %>
      </div>
      <% } %>
      </div>
    </div>
  </div>
</div>

<br /><br />
